---
Demo:
    title: 'Azure 網路安全性群組 (Network Security Group, NSG)'
    module: '單元 3，第 1 課：描述 Microsoft 安全性解決方案的功能：描述 Azure 的基本安全功能。'
---

# 示範：Azure 網路安全性群組 (Network Security Group, NSG)

### 示範案例
在本示範中，您將展示 Azure 網路安全性群組 (NSG) 的功能。  作為預先示範設定的一部分，您將首先建立沒有任何 NSG 的虛擬機器 (Virtual Machine, VM)。您還將建立沒有任何關聯介面或子網路的 NSG。  作為示範的一部分，您將展示 NSG 的預設輸入和輸出規則。然後，您將完成將 VM 的介面指派給 NSG 的流程。  設定完成後，您將使用預設的 NSG 規則以及您將建立的規則測試與 VM 的連線。
  

#### 預先示範設定第 1 部分
 講師建議您在上課**前**進行此操作，因為建立 VM 可能需要幾分鐘的時間。在本設定中，您將建立 Windows 10 虛擬機器。

1. 在瀏覽器上開啟**首頁 – Microsoft Azure** 索引標籤。  如果您先前關閉了索引標籤，請開啟瀏覽器頁面，然後在網址列中輸入 portal.azure.com 並重新登入。

1. 在搜尋方塊中，在頁面頂部 Microsoft Azure 旁邊的藍色列中，輸入**虛擬機器**，然後從搜尋結果中選取**虛擬機器**。  

1. 從頁面左上角，選取 **+新增**，然後選取 **+ 虛擬機器**。

1. 在基本索引標籤中，填寫以下資訊 (對於未列出的內容，保留預設設定)：
    1. **訂用帳戶**：驗證預設設定為 Azure Pass – 贊助。
    1. **資源群組**：請選取**建立新群組**，然後在名稱欄位中輸入 **LabsSC900-RG**，然後選取**確定**。
    1. **虛擬機器名稱**：  輸入 **SC900-WinVM**。
    1. **區域**：  保留預設值。
    1. **顯示狀態選項**：請務必選取**無需基礎結構備援**。  備註：將 「顯示狀態選項」 設定為 「無需基礎結構備援」 非常重要，否則示範將無法如預期執行。  擁有顯示狀態選項需要 NSG，而我們刻意在無 NSG 的情況下建立 VM。
    1. **影像**：  從下拉式清單中，請選取 **Windows 10 Pro，版本 20H2 – Gen 1**。
    1. **尺寸**：  從下拉式清單中選取**查看所有尺寸**，然後選取 **B2s**，然後按下頁面底部的**選取**。
    1. **使用者名稱**：  輸入 **AzureUser**。
    1. **密碼**：  輸入 **SC900AzureLabs**。
    1. **公用輸入連接埠**：  您可以保留預設設定 (無需在意您在此選取的項目，因為網路設定將覆寫您在此處執行的操作)。
    1. **授權**：  請選取**本人確認擁有符合條件具有多租用戶託管權限的 Windows 10 授權**，以便方塊中出現核取記號。
    1. 請選取**下一步：磁碟**。

1. 您現在位於 VM 設定的 「磁碟」 索引標籤中。  將所有設定保留為預設值，然後選取**下一步：網路 >**。

1. 您現在位於 VM 設定的網路索引標籤中。  填寫以下資訊 (對於未列出的內容，保留預設設定)：
    1. NIC 網路安全性群組：  請選取**無**。  備註：選取「無」，即表示您確定 NIC 沒有 NSG。  在示範的後續步驟中，您將建立 NSG 並將 VM NIC 指派至您建立的 NSG。
    1. 由於 VM 的其他設定將保留為預設設定，請繼續並選取下一步：**檢閱 + 建立 >**。

1. 檢閱 VM 的設定。  需注意以下幾點：此 VM 有公共 IP 位址，沒有 NIC 網路安全性群組。  從安全性角度來看，這會讓 VM 暴露在外。  我們將在後續任務中解決此問題。請選取**建立**。  完成 VM 部署可能需要幾分鐘的時間。

1. 請注意網路介面的名稱為 **sc900-winvmXXX** (XXX 將特定於 VM 的網路介面)。

1. VM 部署完成後，請選取**前往資源**。  您現在位於 SC900-WinVM 頁面。  請注意公共 IP 位址。

1. 從左側導覽面板，請選取**網路**並注意網路介面為 **sc900-winvmXXX** (XXX 將特定於 VM 的網路介面)。  不應存有與介面關聯的輸入和輸出規則。  

1. 從頁面頂部，請選取**連線**，因為驗證您是否可以連線至 VM 非常重要。
    1. 從頁面頂部，確保已選取 **RDP** (已畫底線)。
    1. 驗證 IP 位址是否設定為公共 IP 位址，保留預設連接埠編號並選取**下載 DRP 檔案**。
    1. **開啟**已下載的檔案並在出現的視窗中選取**連線**。
    1. 開啟的視窗將提示您輸入認證。如果預設視窗要求輸入 PIN，請選取**更多選取**，然後選取**使用其他帳戶**。   將提示您輸入認證。  請輸入 **AzureUser** 作為使用者名稱。  請輸入 **SC900AzureLabs** 作為密碼。
    1. 遠端桌面連線視窗開啟，顯示無法驗證遠端電腦的身分識別。  仍要繼續連線？  請選取**是**。
    1. 您現在已連線至剛剛建立的 Windows VM。完成 Windows 設定。儘管您透過 RDP 和常用的 RDP 連接埠連線至 VM，但此 VM 的所有連接埠都已開啟，並且沒有篩選流量內容。  透過選取顯示 IP 位址的頁面頂部中心的 **X**，關閉遠端桌面連線。  快顯示窗顯示您的遠端工作階段將會中斷連線。請選取**確定**。

1. 您現在將退回 Azure 入口網站中的 SC900-WinVM 頁面。  保持此瀏覽器索引標籤處於開啟狀態，以供下一個工作使用。

#### 預先示範設定第 2 部分
建立網路安全性群組，不要將 VM 的網路介面指派給 NSG。  

1. 在瀏覽器上開啟 「SC900-WinVM – Microsoft Azure」 索引標籤。

1. 在搜尋方塊中，在頁面頂部 Microsoft Azure 旁邊的藍色列中，輸入**網路安全性群組**，然後從搜尋結果中選取**網路安全性群組**。  請勿選取網路安全性群組傳統。

1. 從網路安全性群組頁面的頂部，選取 **+ 建立**。

1. 在建立網路安全性群組頁面的基本索引標籤上，指定下列設定：
    1. 訂用帳戶：  Azure Pass – 贊助
    1. 資源群組：  **LabsSC900-RG**
    1. 名稱：  **NSG-SC900**
    1. 區域：  保留預設值 **(US) 美國東部**
    1. 請選取**檢閱 + 建立**然後選取**建立**。

1. 部署完成後，請選取**前往資源**並確保一切正確。  應該有 3 個預設輸入規則、3 個預設輸出規則，並且沒有與 NSG 關聯的子網路和介面。  退回至 Azure 入口網站的**首頁**  

#### 示範
逐步了解 NSG 的設定。  在本案例中，您將對尚未指派給 VM 介面的現有 NSG (您在上述設定中建立的 NSG) 進行瀏覽。然後，您將展示將介面關聯至 NSG 的流程以及建立輸入和輸出規則的流程。

1. 開啟瀏覽器索引標籤的**首頁-Microsoft Azure**。  如果您先前關閉了索引標籤，請開啟瀏覽器頁面，然後在網址列中輸入 portal.azure.com 並重新登入。

1. 在搜尋方塊中，在頁面頂部 Microsoft Azure 旁邊的藍色列中，輸入**網路安全性群組**，然後從搜尋結果中選取**網路安全性群組**。  請勿選取網路安全性群組傳統。

1. 在 NSG 頁面中，請選取您在設定中建立的 NSG，**NSG-SC900**。

1. 左側導覽面板中的**概覽**索引標籤將有醒目提示。  請注意 NSG 中的預設輸入和輸出規則。儘管已建立 NSG，並且有預設規則來篩選流量，但是沒有任何介面與 NSG 關聯。您可以在頁面右上角看到「關聯：0 個子網路、0 個網路介面」。  若要讓 NSG 執行此操作，必須為其指派工作。  在本案例中，我們將為先前建立的 VM 指派網路介面。

1. 從 NSG-SC900 頁面左側導覽窗格中的設定下，請選取**網路介面**。

1. 請選取搜尋方塊上方的 **+ 關聯**，然後從下拉式清單中選取 **sc900-winvmXXX** (XXX 將特定於 VM 的網路介面)，然後選取**確定**。當介面已進行關聯時，您將在螢幕右上角看到通知方塊。一旦介面與 NSG 關聯，它就會顯示在清單上。

1. 退回**概覽**索引標籤。  請注意，在頁面的右上角，您將看到「關聯：0 個子網路、1 個網路介面」」– 該介面現已指派給 NSG。此外，向學員強調預設規則。對於輸入，僅允許來自其他 Azure 虛擬網路和 Azure Load Balancer 的流量。到 VM 的所有其他輸入流量都將遭到拒絕。同時指出預設輸出規則。  僅允許到其他 VNet 的輸出流量和輸出網際網路流量。  作為示範的一部分，建議您花一分鐘的時間來顯示輸入流量遭到拒絕。
    1. 在搜尋列的頁面頂部，請輸入並選取**虛擬機器**。
    1. 從虛擬機器頁面中，請選取 **SC900-WinVM**。
    1. 從 SC900-WinVM 頁面的頂部，請選取**連線**，然後選取 **RDP**。
    1. 驗證 IP 位址是否設定為公共 IP 位址，保留預設連接埠編號並選取**下載 DRP 檔案**。
    1. **開啟**已下載的檔案並選取**連線**。
    1. 在嘗試連線幾秒鐘後，您將看到連線失敗訊息，其表明遠端桌面無法連線至遠端電腦。請選取**確定**。

1. 既然您已經展示 NSG 預設輸入規則的影響，您將需要建立新規則以允許輸入 RDP 流量。  請指出，您不能刪除現有預設規則，您只能建立具有更高優先順序的新規則。
    1. 從左側導覽面板的設定下，選取**網路**。  您現在位於 VM 的網路頁面，雖然您可以從此處建立輸入規則和輸出規則，但請退回 NSG 頁面，畢竟本示範為相關 NSG 內容。  **請選取 NSG-SC900**，其為視窗中間的連結。

1. 您現在位於 NSG 概覽頁面。  請注意相關 NSG 的資訊。從 NSG 頁面的左側導覽面板設定下，選取**輸入安全性規則**，然後從頁面頂部選取 **+ 新增**。在新增輸入安全性規則頁面上，討論各種設定內容。建議您實際建立規則以允許輸入 RDP 流量，並使用以下設定：
    1. 來源：**任何**
    1. 來源連接埠範圍：**\***
    1. 目的地：**任何**
    1. 服務：**RDP**
    1. 行動：**允許**
    1. 優先順序：**300**；請注意：編號較小的規則優先順序較高，應首先進行處理。因此，該新規則的優先順序需要高於拒絕所有輸入流量的現有規則的優先順序。
    1. 名稱：**AllowRDP**
    1. 請選取**新增**
    1. 建置規則後，它將出現在輸入規則清單中。

1. 現在請檢查**輸出安全性規則**。  從頁面頂部選取 **+ 新增**，並討論各種設定內容。  本人建議建立規則 – 以下設定會建立規則來拒絕輸出網際網路流量：
    1. 來源：**任何**
    1. 來源連接埠範圍：**\***
    1. 目的地：**服務標籤**
    1. 目的地服務標籤：**網際網路**
    1. 服務：**自訂** (保留預設值)
    1. 目的地連接埠範圍：**\*** (請確保在目的地連接埠範圍欄位中輸入星號)。
    1. 通訊協定: **任何**
    1. 行動：**拒絕**
    1. 優先順序：**4000** (需要指出的是，優先順序需要高於允許網際網路輸出流量的現有規則的優先順序)
    1. 名稱：**DenyInternet**
    1. 請選取**新增**
    1. 建置規則後，它將出現在輸入規則清單中。

1. 現在退回 VM 並測試規則。  從頁面頂部，請選取 **SC900-VM**，在上面顯示輸出安全性規則。

1. 透過驗證是否可以使用 RDP 連線至 VM 來測試輸入規則。
    1. 從左側導覽面板中選取**連線**。
    1. 驗證 IP 位址是否設定為公共 IP 位址，保留預設連接埠編號並選取**下載 DRP 檔案**。
    1. **開啟**已下載的檔案並選取**連線**。
    1. 將提示您輸入認證。請輸入 **AzureUser** 作為使用者名稱。請輸入 **SC900AzureLabs** 作為密碼。  如果提示輸入認證的視窗要求輸入 PIN，請選取**更多選取**，然後選取**使用其他帳戶**。
    1. 遠端桌面連線視窗開啟，顯示無法驗證遠端電腦的身分識別。仍要繼續連線？請選取**是**。
    1. 您現在已連線至 VM。向學員強調，在這種情況下，您能夠連線至 Vm，因為您建立的輸入流量規則允許透過 RDP 向 VM 傳送輸入流量。

1. 現在測試輸出 NSG 規則
    1. 開啟 VM 中的 Edge 瀏覽器。
    1. 輸入 **https://www.bing.com** 該頁面不應顯示。請注意：如果您能夠連線至網際網路並驗證輸出規則的所有參數都已正確設定，則可能是因為該規則需要幾分鐘才會生效。請稍後幾分鐘，然後重試。

1. 透過選取顯示 IP 位址的頁面頂部中心的 **X**，關閉遠端桌面連線。快顯示窗顯示您的遠端工作階段將會中斷連線。請選取**確定**。

1. 透過在頁面頂部的藍色列上選取 **Microsoft Azure**，退回至 Azure 入口網站的首頁。

#### 卸除
**重要**：在此工作中，您將刪除資源群組及其包含的所有資源。   這對於避免額外收費非常重要。

1. 在瀏覽器上開啟 「SC900-WinVM – Microsoft Azure」 索引標籤。

1. 從頁面的左上角，請選取**所有服務**。

1. 在所有服務旁邊的篩選服務方塊中，輸入**資源群組**，然後從結果中選取**資源群組**。

1. 請選取 **LabsSC900-RG**。

1. 從 LabsSC900-RG 頁面的頂部中心，請選取**刪除資源群組**。

1. 在開啟的視窗中，輸入資源群組名稱 **LabsSC900-RG**，確認刪除資源群組及其所有資源，然後從頁面底部選取**刪除**。

1. 刪除所有資源和資源群組可能需要幾分鐘的時間。

#### 回顧

在本示範中，您展示了與 NSG 關聯的資訊和設定，包含將介面與 NSG 關聯的流程，並展示預設輸入和輸出規則，最後為建立新規則的步驟。
